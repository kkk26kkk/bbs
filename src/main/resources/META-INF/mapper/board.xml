<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN"  
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Board">
    <select id="getArticleList" parameterType="com.kkk26kkk.common.model.ArticleParam" resultType="com.kkk26kkk.bbs.model.Article">
    SELECT
            W.*
    FROM    (
			    SELECT
			            X.*
			    FROM    (    
					        SELECT  
					                Z.*, ROWNUM RNUM
					        FROM    (
					                    SELECT 
					                            B.*
					                    FROM    TB_ARTICLE B
					                    INNER JOIN 
					                            TB_NOTICE_ARTICLE C 
					                    ON C.ARTICLE_ID = B.ARTICLE_ID
					                    /*
                                        SELECT  /*+ ORDERED USE_NL(C B) INDEX(C 인덱스이름) INDEX(B 인덱스이름) */
                                                B.*
                                        FROM    TB_NOTICE		C
                                              , TB_ARTICLE		B
                                        WHERE   1               = 1
                                        AND     SYSDATE         BETWEEN NOTICE_STT_DTM  AND NOTICE_END_DTM
                                        AND     C.ARTICLE_ID    = B.ARTICLE_ID
                                        */
                                        
					                    UNION ALL
					                    
								        SELECT
								                Y.*
								        FROM    ( -- TODO 인덱스 추가 (PARENT_ID, ARTICLE_ID)
								                    SELECT  /*+ INDEX_DESC(A SYS_C007000) */
								                            A.* -- TODO 테이블 첫번째 접근시에는 읽어올 컬럼 명시 (전체더라도 전체 다 명시)
								                    FROM    TB_ARTICLE A
                                                        <if test="sort != null">
								                    INNER JOIN
								                      		TB_ARTICLE_RANK R -- // TODO 이거 조인은 쓸 때만 하도록
								                   	ON		R.ARTICLE_ID = A.ARTICLE_ID
                                                        </if>
								                    WHERE   1          = 1
								                    AND     NOT EXISTS (
	                                                                        SELECT 
	                                                                                'X'
	                                                                        FROM    TB_NOTICE
	                                                                        WHERE   ARTICLE_ID = A.ARTICLE_ID
								                                        )
								                    --AND     (#{field} IS NULL OR FIELD    = #{field})
								                    START WITH
								                            PARENT_ID  = 0 -- 기본값 null로 두고, 이 라인 = 0 을 IS NULL 로 변경
								                    CONNECT BY
								                            PARENT_ID  = PRIOR ARTICLE_ID
								                    ORDER SIBLINGS BY -- CHOOSE 기반으로 변경
								                    	<if test="sort == null">
								                            ARTICLE_ID DESC
								                    	</if>
								                        <if test="sort == 'commentCount'">
								                        	(
				                                            	SELECT
				                                                		COUNT(1)
				                                                FROM	TB_COMMENT B
				                                            	WHERE	B.ARTICLE_ID = A.ARTICLE_ID
				                                           	) DESC
				                                        --	R.COMMENT_COUNT_RANK DESC
								                        </if>
								                        <if test="sort == 'readCount'">
								                        	A.READ_COUNT DESC
								                       	--	R.READ_COUNT_RANK DESC
								                        </if>
								                        <if test="sort == 'popularity'">
								                        	R.POPULARITY_RANK DESC
								                        </if>
								                        <if test="sort == 'best'">
								                        	R.BEST_RANK DESC
								                        </if>
								                        <if test="sort == 'rising'">
								                        	R.RISING_RANK DESC
								                        </if>
								                ) Y
					                ) Z
			            ) X
	            <![CDATA[
                WHERE X.RNUM <= ${endNum} 
                ]]>
            ) W
    <![CDATA[
    WHERE W.RNUM >= {startNum}
    ]]>
    </select>
    
    <select id="getArticleCount" resultType="int">
        SELECT COUNT(1)
        FROM tb_article
    </select>
    
    <select id="getFeedArticleList" parameterType="com.kkk26kkk.common.model.ArticleParam" resultType="com.kkk26kkk.bbs.model.Article">
	    SELECT	
	    		X.*
	    FROM	(
				    SELECT	
				    		Y.*
				   	FROM	(
							    SELECT	
							    		Z.*, ROWNUM RNUM
							    FROM	(
									    	SELECT
									    			A.ARTICLE_ID, A.USER_ID, A.USER_NAME, A.TITLE, A.CONTENTS,
									    			A.PARENT_ID, A.READ_COUNT, A.REG_DTM
									    	FROM	TB_ARTICLE	A
									    	START WITH
									                A.PARENT_ID	IS NULL -- 기본값 null로 두고, 이 라인 = 0 을 IS NULL 로 변경
									        CONNECT BY
									                A.PARENT_ID	= PRIOR A.ARTICLE_ID
									        ORDER SIBLINGS BY
									        		A.ARTICLE_ID DESC
										) Z
							) Y
					<![CDATA[
			        WHERE Y.RNUM <= ${endNum} 
			        ]]>
				) X
		<![CDATA[
		WHERE	X.RNUM >= ${startNum}
		]]>
    </select>
    
    <select id="getFeedCommentList" parameterType="com.kkk26kkk.common.model.CommentParam" resultType="com.kkk26kkk.bbs.model.Comment">
    <![CDATA[
    	SELECT	
    			Y.*
		FROM	(
					SELECT 
							Z.*
					FROM	(
						        SELECT  /*+ INDEX_DESC(C TB_COMMENT_PK) */
						        		C.*
						        	  , ROW_NUMBER() OVER(PARTITION BY ARTICLE_ID ORDER BY REG_DTM DESC) AS RNUM
						        FROM	TB_COMMENT		C
						        WHERE	C.ARTICLE_ID	IN	(${articleId}) -- TODO
      						) Z
			        WHERE Z.RNUM <= ${endNum} 
				) Y
		WHERE Y.RNUM >= {startNum}
        ]]>
    </select>
</mapper>